<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>IDAMS - Bangladesh</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <script type="text/javascript" src="./js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="./js/d3.4.2.6.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="./keshif/keshif.js" charset="utf-8"></script>
    <link rel="stylesheet" href="./keshif/keshif.css" type="text/css">
    <link rel="stylesheet" href="./font-awesome/css/font-awesome.min.css">

    <script type="text/javascript" src="./keshif/custom.js" charset="utf-8"></script>
    <link rel="stylesheet" href="./keshif/custom.css" type="text/css">

    <script type="text/javascript" src="./js/pikaday.js" charset="utf-8"></script>
    <link rel="stylesheet" href="./js/pikaday.css" type="text/css">

    <script src="./js/topojson.min.js"></script>
    <link rel="stylesheet" href="./leaflet/leaflet.css" />
    <script src="./leaflet/leaflet.js"></script>

    <script type="text/javascript">

var demoHeader = true;
var socialShare = false;

var _geo = {}; // holds indexed geo-json objects for mapping

// To process raw GeoJSON files:
// mapshaper -i bgd_bnd_adm1.json -simplify 10% -o simple1.json
// mapshaper -i bgd_bnd_adm3.json -simplify 1%  -o simple3.json // 1MB
// topojson -o adm_1.json simple1.json -p
// topojson -o adm_2.json simple2.json -p
// topojson -o adm_3.json simple3.json -p

function loadData(browser){
  // Load topojson file
  var records = kshf.dt_id["Country Data (2012)"];
  browser.asyncDataWaitedCnt+=3;
  $.ajax({
    url: './geojson/adm_1.json',
    async: false,
    success: function(topojsonData){
      topojson.feature(topojsonData, topojsonData.objects.simple1)
        .features.forEach(function(feature){ _geo["1_"+feature.properties.Division] = feature; });
      browser.asyncDataLoaded();
    }
  });
  $.ajax({
    url: './geojson/adm_2.json',
    async: false,
    success: function(topojsonData){
      topojson.feature(topojsonData, topojsonData.objects.simple2)
        .features.forEach(function(feature){ _geo["2_"+feature.properties.District] = feature; });
      browser.asyncDataLoaded();
    }
  });
  $.ajax({
    url: './geojson/adm_3.json',
    async: false,
    success: function(topojsonData){
      topojson.feature(topojsonData, topojsonData.objects.simple3)
        .features.forEach(function(feature){ _geo["3_"+feature.properties.Upazila] = feature; });
      browser.asyncDataLoaded();
    }
  });
};

function getActor(v){
  switch(v){
    case 'Cargo vehicle':
    case 'Passenger vehicle':
    case 'Private vehicle':
    case 'Improvised vehicle':
    case 'Train':
    case 'Motorcycle':
    case 'Rickshaw':
    case 'Bicycle':
    case 'CNG tricycle':
    case 'Airplane/helicopter': return 'Motorized Vehicle';

    case 'Fire':
    case 'Flood':
    case 'Health/Medical':
    case 'Landslide/Mudslide':
    case 'Landslide/Mudslide/Snowslide':
    case 'Thunderstorm':
    case 'Earthquake':
    case 'Fire Outbreak':
    case 'Boat Accident':
    case 'Other Hazard': return 'Hazard';

    case 'Public Space':
    case 'Public building/facility':
    case 'Other public property':
    case 'Real estate property':
    case 'Real estate':
    case 'Commercial property':
    case 'Other private property': return 'Public and Private Property';

    case 'Hindu':
    case 'Buddhist':
    case 'Budhist':
    case 'Christian':
    case 'Ethnic minorities': return 'Religious and Ethnic Minorities';

    case 'Joint Force Bangladesh':
    case 'Police Force Bangladesh':
    case 'Rapid Action Batallion':
    case 'Border Guard Bangladesh':
    case 'Bangladesh Ansars and Village Defence Party': return 'Bangladesh Security Forces';

    case 'Coast Guard Bangladesh':
    case 'Army Bangladesh':
    case 'Navy Bangladesh':
    case 'Air Force Bangladesh': return 'Armed Forces';

    case 'Bangladesh Sramik League':
    case 'Bangladesh Kirshak League':
    case 'Bangladesh Swechchasebak':
    case 'Bangladesh Swechchasebak Leauge':
    case 'Bangladesh Swechchasebak League': return "Other Awami League Branch";

    case 'Jatiyatabadi Sramik Dal':
    case 'Jatiyatabadi Krishak Dal':
    case 'Jatiyatabadi Sechchasebak Dal': return "Other BNP Branch";
    
    case 'Zaker Party':
    case 'Khelafat Andolon':
    case 'Mulsim League':
    case 'Islami Andolan':
    case 'Islamic Front':
    case 'Havezat-e-Islam':
    case 'Islami Oikya Jote':
    case 'Khelafat Majlish,':
    case 'Jamiyate Ulamaye Islam': return "Other Islamist Leaning Parties";
    
    case 'Central Government':
    case 'Central government':
    case 'Local Government':
    case 'Local government':
    case 'Civil Service':
    case 'Election Commission':
    case 'Human Rights Commission':
    case 'Information Commission':
    case 'Anti Corruption Commission':
    case 'Judicial Institutions':
    case 'Universities': return "Public Institutions";

    case 'Bangladesh Chhatro Union':
    case 'Pragatishil Chhatro Jote':
    case 'Biplobi Chhatro Moitry':
    case 'Samajtantrik Chhatro Front':
    case 'Communist Party of Bangladesh':
    case 'Socialist Party of Bangladesh':
    case 'Jatiyo Samajtantrik Dal':
    case 'Revolutionary Workers Party':
    case 'Bangladesher Samyabadi Dal':
    case 'Bikalpa Dhara Bangladesh':
    case 'Ganatantrik Party':
    case 'Krishak Sramik Janata League':
    case 'Gonoforum Party':
    case 'Jatiya Party':
    case 'Bangladeshw Nationalist Front':
    case 'Bangladesh Tariqat Federation':
    case 'Ganatantri Party':
    case 'United Peoples Party':
    case 'Progressive Democratic Party':
    case 'Liberal Democratic Party':
    case 'Bikalpadhara Bangladesh':
    case 'Kalyan Party':
    case 'Bangladesher Sammaybadi Dal':
    case 'Bangladesher Samajtantrik Dal':
    case 'Nagorik Oikyya-Manna':
    case 'Gana Sanghati Andolan':
    case 'Jatiya Ganatantrik Party':
    case 'Jatiya Samajtantrik Dal':
    case 'National People\'s Party':
    case 'Oikyabaddha Nagarik Andolan':
    case 'Parbatya Chattagram Jana Sanghati Samiti (Reformist)':
    case 'Parbatya Chattagram Jana Sanghati Samiti':
    case 'United Peoples Democratic Front': return "Other Political Parties";

  }
  return v;
}

var mapLevelSelectDOM = null;

function setMapRegionLevel(v){
  browser.needToRefreshLayout = true;
  var summary = browser.summaries_by_name["Location of the Incident"];
  summary.DOM.aggrGroup.attr("class","leaflet-zoom-hide aggrGroup mapLevel_"+v);
  summary._aggrs.forEach(function(aggr){
    var aggrLevel = aggr.data.id[0];
    aggr.usedAggr = aggrLevel===v;
  });
  if(mapLevelSelectDOM) mapLevelSelectDOM.node().value = v;
  summary.updateCatSorting();
  summary.updateChartScale_Measure();
  summary.refreshViz_Active();
};

$(document).ready( function() {
  browser = new kshf.Browser({
    domID: "#demo_Browser",
    recordName: "Incidents",
    source: {
      dirPath: 'https://storage.googleapis.com/keshif-data/',
      fileType: "json",
      tables: "incidents",
      callback: loadData
    },
    onLoad: function(){
      var p = d3.timeParse("%Y-%m-%d");
      this.records.forEach(function(r){
        r.data.Date = p(r.data.Date);
        //if(r.data.Date) return r.data.Date.getFullYear()>2014;
      });

      var d=new Date(2015,6,1);
      d = d.getTime();
      this.records = this.records.filter(function(r){
        if(r.data.Date) {
          return r.data.Date.getTime() >= d;
        }
        return true;
      });
    },
    onReady: function(){
      var s = this.summaries_by_name["Location of the Incident"];
      for(var id in s.catTable_id){
        var dom = s.catTable_id[id].DOM.aggrGlyph;
        d3.select(dom).classed("geo_level_"+id.substr(0,1),true);
      };

      var h =  s.DOM.summaryControls.style('height','22px')
        .append("div").styles({ 
          display: "inline-block",
          position: "absolute",
          top: "2px",
          right: "15px",
          "font-size": "0.8em",
          "font-weight": "300",
        });
      h.append("span").text("View by: ");
      mapLevelSelectDOM = h.append("select")
        .on("change", function(){ 
          setMapRegionLevel(this.value);
        });
      
      mapLevelSelectDOM.append("option").attr("value",1).text("Division");
      mapLevelSelectDOM.append("option").attr("value",2).text("District");
      mapLevelSelectDOM.append("option").attr("value",3).text("Upazila");

      setMapRegionLevel("2");

      var N = d3.select(".panel.panel_middle").node();
      N.parentNode.insertBefore(N,N.parentNode.firstChild);

      this.summaries_by_name["District"].destroy();
      this.summaries_by_name["Division"].destroy();
      this.summaries_by_name["Upazila"].destroy();

      this.recordDisplay.collapseRecordViewSummary(true);
      this.recordDisplay.DOM.recordDisplayName.html("Incident Descriptions");

/*
      this.summaries_by_name["Incident Cause"].destroy();
      this.summaries_by_name["Incident Cause 1"].destroy();
      this.summaries_by_name["Incident Cause 2"].destroy();
      this.summaries_by_name["Perpetrator"].destroy();
      this.summaries_by_name["Perpetrator 1"].destroy();
      this.summaries_by_name["Perpetrator 2"].destroy();
      this.summaries_by_name["Perpetrator 3"].destroy();
      this.summaries_by_name["Perpetrator 4"].destroy();
      this.summaries_by_name["Perpetrator 5"].destroy();
      this.summaries_by_name["Risk Category"].destroy();
      this.summaries_by_name["Risk Category 1"].destroy();
      this.summaries_by_name["Risk Category 2"].destroy();
      this.summaries_by_name["Type of Casualty"].destroy();
      this.summaries_by_name["Type of Casualty 2"].destroy();
      this.summaries_by_name["Type of Casualty 3"].destroy();
      this.summaries_by_name["Victims"].destroy();
      this.summaries_by_name["Victim 1"].destroy();
      this.summaries_by_name["Victim 2"].destroy();
      this.summaries_by_name["Victim 3"].destroy();
      this.summaries_by_name["Victim 4"].destroy();
      this.summaries_by_name["Victim 5"].destroy();
      
      this.summaries_by_name["Latitude"].destroy();
      this.summaries_by_name["Longitude"].destroy();
      
      this.summaries_by_name["Casualty Count"].destroy();
      this.summaries_by_name["Casualty Count 1"].destroy();
      this.summaries_by_name["Casualty Count 2"].destroy();
      this.summaries_by_name["Casualty Count 3"].destroy();
      
      this.summaries_by_name["Type of Consequence 1"].destroy();

      */

    },
    summaries: [
      { name: "Incident Type",
        value: function(){
          switch(this.Type){
            case 'Demonstration':
            case 'Procession':
            case 'Strike': return 'Demonstration';
            
            case 'General Strike':
            case 'Call for Blockade': return 'General Strike';
            
            case 'Fire': 
            case 'Water Accident ':
            case 'Water Accident':
            case 'Railway accident':
            case 'Infrastructure failure': return 'Other Hazards';

            case 'Natural Hazard':
            case 'Thunderstorm': return 'Natural Hazards';
            //case '': return '';
          }
          return this.Type;
        }
      },
      { name: "Casualty Types", 
        value: function(){
          var r=[];
          if(this.Consequences) this.Consequences.forEach(function(c){
            switch(c){
              case 'Sentence / verdict': return;
              case 'Arms and weapons recovered': return;
              case 'Rescued': return;
              case 'Rescued ': return;
              case 'Case filed': return;
              case 'Missing': return;
              case 'Property loss': return;
              case 'Torture': return;
              case 'Delivered Extradition': return;
              case 'IED recovered': return;
              case 'Section 144 Imposed': return;
              case 'Vehicle damaged': return;
              case 'No Consequence Reported': return;
              case 'Firearms recovered': return;
              case 'IED and other explosives recovered': return;
              case 'Ammunition recovered': return;
              case 'Ammunition or IED material recovered': return;
            }
            r.push(c);
          });
          return r;
        }
      },
      { name: "Incident Motivations", 
        value: function(){
          var r=[];
          if(this.Causes) this.Causes.forEach(function(c){
            switch(c){
              case 'Tender submission/contracts':
              case 'Labor rights':
              case 'Other private dispute':
              case 'Personal dispute':
              case 'Dispute over wages':
              case 'Private dispute': c = 'Economic and Social Motivations'; break;
              case 'Narcotics':
              case 'Armed robbery':
              case 'Petty crime':
              case 'Organized crime':
              case 'honor killing':
              case 'General citizen safety':
              case 'Looting': c = 'Other Crimes'; break;
              case 'Ransom': c = 'Extortion'; break;
              case 'Graft':
              case 'Bribe':
              case 'Political rights':
              case 'Other political motivations': c = 'Other Political Motivations'; break;
              case 'Hartal/Blocakde':
              case 'Hartal/Blockade':
              case 'Other Motivations':
              case 'Unknown Motivations': c = 'Other Motivations'; break;
              case 'Radicalism / fundamentalism':
              case 'Other religious motivation': c = 'Religious Motivations'; break;
              case 'Sedition / defamation':
              case 'Sedition/sabotage/defamation':
              case 'Sabotage': c = 'Sedition/Sabotage/Defamation'; break;
            }
            r.push(c);
          });
          return r;
        },
      },
      /* { name: "Risk Categories", collapsed: true,
        value: function (){
          return [this['Risk Category 1'], this['Risk Category 2'], this['Risk Category']];
        } }, */
      {
        name: "Location of the Incident",
        value: function(){
          var r=[];
          r.push("1_"+this.Division);
          r.push("2_"+this.District);
          r.push("3_"+this.Upazila);
          return r;
        },
        panel: "middle",
        viewAs: "map", // TODO: Fix. if not initialized as map, geo_level_ variable is not set.
        mapInitView: [
          23.654587852202987, // lat
          90.340576171875, // long
          7 //zoom
        ],
        catLabel: function(){ return this.id.substr(2,10000); },
        catMap: function(){ return _geo[this.id]; },
        onMapProject: function(){
          var v= this.leafletAttrMap.getZoom();
          if(v<8){
            setMapRegionLevel('1');
          }
          if(v==8){
            setMapRegionLevel('2');
          }
          if(v>8){
            setMapRegionLevel('3');
          }
        }
        // auto adjust the zoom level on zoom
      },
      { name: "Victim Types",
        value: function(){
          var r=[];
          if(this.Responders) this.Responders.forEach(function(c){
            var v = getActor(c);
            if(v) r.push(v);
          });
          return r;
        },
        panel: "right" },
      { name: "Perpetrator Types",
        value: function(){
          var r=[];
          if(this.Instigators) this.Instigators.forEach(function(c){
            var v = getActor(c);
            if(v) r.push(v);
          });
          return r;
        },
        panel: "right" },
      { name: "Date",
        panel: "left" },
      {
        name: "Number of Victims",
        value: "NumVictims",
        panel: 'none',
        skipZero: true
      },
      {
        name: "Number of Deaths",
        value: "NumDeaths",
        panel: 'right',
        collapsed: true,
        skipZero: true
      },
      {
        name: "Number of Injuries",
        value: "NumInjuries",
        panel: 'right',
        collapsed: true,
        skipZero: true
      }
/*      { name: "Death Casualty on Incident",
        panel: "right",
        value: function(){
          if(this['Type of Casualty']==='Death' && this['Casualty Count']) return this['Casualty Count'];
        },
        collapsed: true,
      }*/
    ],
    leftPanelLabelWidth: 250,
    rightPanelLabelWidth: 200,
    middlePanelLabelWidth: 160,
    barChartWidth: 120,
    recordDisplay: {
      displayType: "list",
      sortBy: "Date",
      sortColWidth: 69,
      detailsToggle: "zoom",
      recordView: function(){
        return "<span class='clickForDetails' onClick='showIncidentDetails();'> "+this.Description+" </span>";
      },
      onDetail: function(){
        return "<iframe src='http://idams-bd.org/data-entry/incident/view/"
          +this._id+"' style='height: 70vh; width: 70vw;'>";
      }
    }
  }
  );
});

function showIncidentDetails(){
  var r = this.event.target.parentNode.__data__;
  browser.updateRecordDetailPanel(r);
};
    </script>
	</head>
<style>
.kshf .aggrGlyph.geo_level_1{ display: none; }
.kshf .aggrGlyph.geo_level_2{ display: none; }
.kshf .aggrGlyph.geo_level_3{ display: none; }

.kshf .mapLevel_1 > .aggrGlyph.geo_level_1{ display: block; }
.kshf .mapLevel_1 > .aggrGlyph.geo_level_2{ display: none; }
.kshf .mapLevel_1 > .aggrGlyph.geo_level_3{ display: none; }

.kshf .mapLevel_2 > .aggrGlyph.geo_level_1{ display: none; }
.kshf .mapLevel_2 > .aggrGlyph.geo_level_2{ display: block; }
.kshf .mapLevel_2 > .aggrGlyph.geo_level_3{ display: none; }

.kshf .mapLevel_3 > .aggrGlyph.geo_level_1{ display: none; }
.kshf .mapLevel_3 > .aggrGlyph.geo_level_2{ display: none; }
.kshf .mapLevel_3 > .aggrGlyph.geo_level_3{ display: block; }

.kshfRecord .content{
  font-size: 13px;
  font-weight: 300;
}

.kshfSummary[summary_id="38"][isMultiValued]:hover .setMatrixButton{ display: none !important; }
.kshf .recordDisplay{ top: 4px !important; }
.scaleModeControl.measureAxis_2{ display: none !important; }
.tick > .text.measureAxis_2{ display: none !important; }

.clickForDetails{
  font-size: 0.9em;
  color: gray;
}
</style>
  <body>
    <div class="contents">
      <div id="demo_PageTitle">IDAMS - Bangladesh</div>
      <div id="demo_Browser"></div>
      </div>
  </body>
</html>